name: Run Code Checks

on:
  pull_request:
  push:
    paths:
      - '**'
      - '!notebooks/**'
      - '!docs/**'
      - '!old/**'
      - '!README.md'

jobs:
  build-wheels:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup Python
      uses: actions/setup-python@v1
      with:
        python-version: 3.8

    - uses: actions/cache@v2
      id: wheels_cache
      with:
        path: ./wheels
        key: wheels-${{ github.sha }}

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install --upgrade setuptools
        python -m pip install --upgrade \
         toml \
         wheel \
         twine
        python -m pip freeze

    - name: Patch Package Versions
      if: |
        github.ref != 'refs/heads/stable'
      run: |
        find . -name _version.py | xargs python ./scripts/patch_version.py ${GITHUB_RUN_NUMBER:-0}

    - name: Build Packages
      run: |
        mkdir -p ./wheels
        ./scripts/build-wheels.sh ./wheels
        find ./wheels -type f

  build-test-env-base:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - uses: actions/cache@v2
      id: conda_cache
      with:
        path: |
          tests/env

        key: ${{ runner.os }}-test-env-py38-${{ hashFiles('tests/test-env-py38.yml') }}

    - uses: conda-incubator/setup-miniconda@v2
      if: steps.conda_cache.outputs.cache-hit != 'true'
      with:
        channels: conda-forge,defaults
        channel-priority: true
        activate-environment: ""
        mamba-version: "*"
        use-mamba: true

    - name: Dump Conda Environment Info
      shell: bash -l {0}
      if: steps.conda_cache.outputs.cache-hit != 'true'
      run: |
          conda info
          conda list
          mamba -V
          conda config --show-sources
          conda config --show
          printenv | sort

    - name: Build Python Environment for Testing
      shell: bash -l {0}
      if: steps.conda_cache.outputs.cache-hit != 'true'
      run: |
        mamba env create -f tests/test-env-py38.yml -p tests/env

    - name: Check Python Env
      shell: bash -l {0}
      if: steps.conda_cache.outputs.cache-hit != 'true'
      run: |
        mamba env export -p tests/env


  run-tests:
    runs-on: ubuntu-latest

    needs:
      - build-wheels
      - build-test-env-base

    steps:
    - uses: actions/checkout@v2

    - name: Get Wheels from Cache
      uses: actions/cache@v2
      id: wheels_cache
      with:
        path: ./wheels
        key: wheels-${{ github.sha }}

    - name: Get Conda Environment from Cache
      uses: actions/cache@v2
      id: conda_cache
      with:
        path: |
          tests/env

        key: ${{ runner.os }}-test-env-py38-${{ hashFiles('tests/test-env-py38.yml') }}

    - name: Update PATH
      shell: bash
      run: |
        echo "$(pwd)/tests/env/bin" >> $GITHUB_PATH

    - name: Install wheels for testing
      shell: bash
      run: |
        which python
        which createdb
        which datacube

        ls -lh wheels/
        python -m pip install --no-deps wheels/*whl
        python -m pip check || true

    - name: Start Test DB
      shell: bash
      run: |
        echo "Launching test db"
        pgdata=$(pwd)/.dbdata
        initdb -D ${pgdata} --auth-host=md5 --encoding=UTF8
        pg_ctl -D ${pgdata} -l "${pgdata}/pg.log" start
        createdb datacube
        datacube system init

      env:
        DATACUBE_DB_URL: postgresql:///datacube

    - name: Run Tests
      shell: bash
      run: |
        datacube system check

        echo "Running Tests"
        ./tests/env/bin/pytest --cov=. \
        --cov-report=html \
        --cov-report=xml:coverage.xml \
        --timeout=30 \
        libs apps

      env:
        AWS_DEFAULT_REGION: us-west-2
        DASK_TEMPORARY_DIRECTORY: /tmp/dask
        DATACUBE_DB_URL: postgresql:///datacube

    - name: Upload Coverage
      if: |
        github.repository == 'opendatacube/odc-tools'

      uses: codecov/codecov-action@v1
      with:
        fail_ci_if_error: false
        verbose: false


  publish-wheels:
    needs:
      - build-wheels
      - run-tests

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - uses: actions/cache@v2
      id: wheels_cache
      with:
        path: ./wheels
        key: wheels-${{ github.sha }}

    - name: Prepare for upload to S3
      run: |
        mkdir -p ./pips
        ./scripts/mk-pip-tree.sh ./wheels ./pips
        find ./pips -type f

    - name: Upload to S3
      if: |
        github.ref == 'refs/heads/develop'
        && github.event_name == 'push'
        && github.repository == 'opendatacube/odc-tools'

      run: |
        echo "Using Keys: ...${AWS_ACCESS_KEY_ID:(-4)}/...${AWS_SECRET_ACCESS_KEY:(-4)}"
        aws s3 ls "${S3_DST}"
        aws s3 sync ./pips/ "${S3_DST}"

      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: 'ap-southeast-2'
        AWS_REGION: 'ap-southeast-2'
        S3_DST: 's3://datacube-core-deployment/'
