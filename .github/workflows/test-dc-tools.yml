name : Run integration tests on dc_tools

on:
  pull_request:
  push:

jobs:
  test-dc-tools:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Pull test docker
      run: |
        docker pull opendatacube/odc-test-runner:latest

    - name: Run Dockerized Tests
      timeout-minutes: 20
      shell: bash
      run: |
        cd tests
        docker-compose up -d
        # Manually install over the top
        docker-compose exec -T tools-tester pip install -r /code/docker/rr-odc-tools.in
        # Prove that worked ^
        dc-sync-products --help
        # Now set up some metadata and products
        docker-compose exec -T tools-tester bash -c \
          "/code/apps/dc_tools/assets/bootstrap-odc.sh \$PRODUCT_CATALOG \$METADATA_CATALOG"
        # And run the real tests
        docker-compose exec -T tools-tester pytest --cov=/code/ --cov-report xml:coverage.xml --timeout=30

    - name: Upload Coverage
      uses: codecov/codecov-action@v1
      with:
        fail_ci_if_error: false
        verbose: false
